name: CI

on:
  pull_request:
    branches:
      - main
      - staging
      - ci-cd
  push:
    branches:
      - main
      - staging
      - ci-cd

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  MIN_COVERAGE: "80.0"

jobs:
  ci:
    name: Rust CI
    runs-on: ubuntu-latest
    outputs:
      coverage_pct: ${{ steps.coverage.outputs.coverage_pct }}
      min_coverage: ${{ steps.coverage.outputs.min_coverage }}
      lock_hash: ${{ steps.lock_hash.outputs.lock_hash }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup stable Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy, llvm-tools-preview

      - name: Cache Cargo registry + target
        uses: Swatinem/rust-cache@v2
        with:
          cache-targets: true
          cache-all-crates: true

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Verify Cargo.lock is up-to-date
        shell: bash
        run: |
          cp Cargo.lock /tmp/Cargo.lock.before
          cargo generate-lockfile
          if ! cmp -s Cargo.lock /tmp/Cargo.lock.before; then
            echo "::error::Cargo.lock is out of date. Run 'cargo generate-lockfile' and commit Cargo.lock."
            diff -u /tmp/Cargo.lock.before Cargo.lock || true
            exit 1
          fi

      - name: Compute Cargo.lock SHA-256 hash
        id: lock_hash
        shell: bash
        run: |
          mkdir -p artifacts
          lock_hash="$(sha256sum Cargo.lock | awk '{print $1}')"
          echo "${lock_hash}  Cargo.lock" | tee artifacts/cargo-lock.sha256
          echo "lock_hash=${lock_hash}" >> "${GITHUB_OUTPUT}"

      - name: rustfmt check
        run: cargo fmt --all -- --check

      - name: clippy (warnings denied)
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Unit tests
        run: cargo test --workspace --all-targets --all-features --locked

      - name: Coverage gate (cargo-llvm-cov)
        id: coverage
        shell: bash
        env:
          MIN_COVERAGE: ${{ env.MIN_COVERAGE }}
        run: |
          mkdir -p artifacts
          cargo llvm-cov clean --workspace
          cargo llvm-cov --workspace --all-features --all-targets --summary-only | tee artifacts/coverage-summary.txt

          coverage_pct="$(awk '/^TOTAL/ {
            for (i = NF; i >= 1; i--) {
              if ($i ~ /%$/) {
                gsub("%", "", $i);
                print $i;
                break;
              }
            }
          }' artifacts/coverage-summary.txt | tail -n1)"
          if [[ -z "${coverage_pct}" ]]; then
            echo "::error::Failed to parse coverage percentage from cargo-llvm-cov output."
            echo "::group::coverage-summary.txt"
            cat artifacts/coverage-summary.txt
            echo "::endgroup::"
            exit 1
          fi
          if ! [[ "${coverage_pct}" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
            echo "::error::Coverage value is not numeric: ${coverage_pct}"
            exit 1
          fi

          printf "coverage_pct=%s\nmin_coverage=%s\n" "${coverage_pct}" "${MIN_COVERAGE}" | tee artifacts/coverage-threshold.txt
          awk -v cov="${coverage_pct}" -v min="${MIN_COVERAGE}" 'BEGIN { exit (cov + 0 >= min + 0) ? 0 : 1 }'

          echo "coverage_pct=${coverage_pct}" >> "${GITHUB_OUTPUT}"
          echo "min_coverage=${MIN_COVERAGE}" >> "${GITHUB_OUTPUT}"

          cargo llvm-cov --workspace --all-features --all-targets --lcov --output-path artifacts/lcov.info

      - name: Upload coverage + lock hash artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ci-artifacts-${{ github.run_id }}
          path: |
            artifacts/cargo-lock.sha256
            artifacts/coverage-summary.txt
            artifacts/coverage-threshold.txt
            artifacts/lcov.info
          if-no-files-found: error

  docker_cd:
    name: Docker CD
    runs-on: ubuntu-latest
    needs: [ci]
    permissions:
      contents: read
      packages: write
    if: >-
      ${{
        needs.ci.result == 'success' &&
        github.event_name == 'push' &&
        (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging') &&
        fromJSON(needs.ci.outputs.coverage_pct || '0') >= fromJSON(needs.ci.outputs.min_coverage || '80.0')
      }}
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Dockerfile exists
        run: test -f Dockerfile

      - name: Set image metadata
        id: image
        shell: bash
        run: |
          image_ref="$(echo "${REGISTRY}/${IMAGE_NAME}" | tr '[:upper:]' '[:lower:]')"
          echo "image_ref=${image_ref}" >> "${GITHUB_OUTPUT}"
          echo "sha_tag=${GITHUB_SHA}" >> "${GITHUB_OUTPUT}"
          echo "branch_tag=${GITHUB_REF_NAME}" >> "${GITHUB_OUTPUT}"

      - name: Build Docker image
        run: |
          docker build \
            --tag "${{ steps.image.outputs.image_ref }}:${{ steps.image.outputs.sha_tag }}" \
            --tag "${{ steps.image.outputs.image_ref }}:${{ steps.image.outputs.branch_tag }}" \
            .

      - name: Login to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Push Docker image
        run: |
          docker push "${{ steps.image.outputs.image_ref }}:${{ steps.image.outputs.sha_tag }}"
          docker push "${{ steps.image.outputs.image_ref }}:${{ steps.image.outputs.branch_tag }}"

      - name: Deploy placeholder
        run: |
          echo "Deploy gate passed on branch '${GITHUB_REF_NAME}' with coverage ${{ needs.ci.outputs.coverage_pct }}%."
          echo "Integrate your runtime deploy command here."

      # Optional alternative using Docker Buildx + GHCR:
      # - name: Login to GHCR (Buildx)
      #   uses: docker/login-action@v3
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GITHUB_TOKEN }}
